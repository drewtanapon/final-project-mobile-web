<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>จัดการห้องเรียน</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
  <!-- QRCode.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* กำหนดสไตล์พื้นฐาน */
    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    /* ส่วนหัวแสดงข้อมูลวิชา */
    .header {
      background-image: url('subject-bg.jpg'); /* รูปพื้นหลังของวิชา ควรเปลี่ยนเป็น dynamic */
      background-size: cover;
      background-position: center;
      color: #000000;
      padding: 20px;
    }
    .subject-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .subject-code {
      color: #000000;
      font-size: 24px;
      font-weight: bold;
    }
    .subject-name {
      color: #000000;
      font-size: 20px;
      margin-top: 5px;
    }
    /* ปุ่มในส่วนหัว */
    .header .buttons {
      margin-top: 15px;
    }
    .header .buttons button {
      margin-right: 10px;
      padding: 8px 12px;
      background-color: #007bff;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .header .buttons button:hover {
      background-color: #0056b3;
    }
    /* ส่วนคอนเทนต์หลัก */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
    }
    /* ตารางแสดงนักเรียนที่ลงทะเบียน */
    .student-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .student-table th, .student-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .student-table th {
      background-color: #007bff;
      color: #fff;
    }
    /* ส่วนประวัติการเช็คชื่อ */
    .history {
      margin-top: 30px;
    }
    .history h3 {
      margin-bottom: 10px;
    }
    .history ul {
      list-style-type: none;
      padding: 0;
    }
    .history li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    /* Modal สำหรับแสดง QR Code */
    #qr-modal {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #qr-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 300px;
      text-align: center;
      border-radius: 8px;
      position: relative;
    }
    #qr-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
    }
    /* Modal สำหรับเพิ่มการเช็คชื่อ */
    #checkin-modal {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #checkin-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 400px;
      border-radius: 8px;
      position: relative;
    }
    #checkin-modal .modal-content h3 {
      margin-top: 0;
    }
    #checkin-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
    }
    /* สไตล์ฟอร์มใน Modal */
    #checkin-form-modal div {
      margin-bottom: 10px;
    }
    #checkin-form-modal label {
      display: block;
      margin-bottom: 5px;
    }
    #checkin-form-modal input {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
    #checkin-form-modal button {
      padding: 8px 12px;
      background-color: #28a745;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #checkin-form-modal button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <!-- ส่วนหัวแสดงข้อมูลวิชา -->
  <div class="header">
    <div class="subject-info">
      <div class="subject-code">
        <p><strong>รหัสวิชา: </strong><span id="display-subjectCode"></span></p>
      </div>
      <div class="subject-name">
        <p><strong>ชื่อรายวิชา: </strong><span id="display-subjectName"></span></p>
      </div>
    </div>
    <div class="buttons">
      <button id="btn-qr">แสดง QR Code</button>
      <button id="btn-checkin">เพิ่มการเช็คชื่อ</button>
      <button id="btn-check-in" onclick ="toCheckin()" >Check-in</button>
      <button id="btn-createq" onclick="toggleCreateQiuz()">สร้างคำถาม</button>
    </div>
  </div>

  <!-- ส่วนแสดงรายละเอียดภายในห้องเรียน -->
  <div class="container">
    <!-- ตารางรายชื่อนักเรียนที่ลงทะเบียน -->
    <h2>รายชื่อนักเรียนที่ลงทะเบียน</h2>
    <table class="student-table">
      <thead>
        <tr>
          <th>ลำดับ</th>
          <th>รหัส</th>
          <th>ชื่อ</th>
          <th>รูปภาพ</th>
          <th>สถานะ</th>
        </tr>
      </thead>
      <tbody id="student-table-body">
        <!-- ข้อมูลนักเรียนจะถูกเติมที่นี่ -->
        <tr>
          <td>1</td>
          <td>STU001</td>
          <td>สมชาย ใจดี</td>
          <td><img src="" alt="student1" width="50"></td>
          <td>Active</td>
        </tr>
      </tbody>
    </table>

    <!-- แสดงรายการประวัติการเช็คชื่อ -->
    <div class="history">
      <h3>ประวัติการเช็คชื่อ</h3>
      <ul id="checkin-history">
        <!-- รายการประวัติจะถูกเติมที่นี่ -->
        <li id="checkin-list"></li>
      </ul>
    </div>
  </div>

  <!-- Modal สำหรับแสดง QR Code -->
  <div id="qr-modal">
    <div class="modal-content">
      <span class="close" onclick="closeQR()">×</span>
      <div id="qr-code">
        <!-- QR Code จะแสดงที่นี่ -->
      </div>
    </div>
  </div>

  <!-- Modal สำหรับเพิ่มการเช็คชื่อ -->
  <div id="checkin-modal">
    <div class="modal-content">
      <span class="close" id="close-checkin-modal">×</span>
      <h3>สร้างการเช็คชื่อใหม่</h3>
      <form id="checkin-form-modal">
        <div>
          <label>รหัสเช็คชื่อ:</label>
          <input type="text" id="modal-checkin-code" required>
        </div>
        <div>
          <label>วันเวลาเริ่มเช็คชื่อ:</label>
          <input type="datetime-local" id="modal-start-time" required>
        </div>
        <div>
          <label>วันเวลาถือว่าสาย:</label>
          <input type="datetime-local" id="modal-late-time" required>
        </div>
        <div>
          <label>วันเวลาปิดการเช็คชื่อ:</label>
          <input type="datetime-local" id="modal-close-time" required>
        </div>
        <button type="submit">บันทึก</button>
      </form>
    </div>
  </div>

  <script>
    // ดึง subjectId จาก query string
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('subjectId');

    console.log(subjectId);

    let currentUserUID = "";
    const firebaseConfig = {
      apiKey: "AIzaSyAPOWp35o6ubJy0SE_PlAqimqa1-siXfVk",
      authDomain: "webmobileapplication-cdaaf.firebaseapp.com",
      projectId: "webmobileapplication-cdaaf",
      storageBucket: "webmobileapplication-cdaaf.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ดึงข้อมูลรายวิชาจาก Firestore ด้วย subjectId
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUserUID = user.uid;

        db.collection("users")
          .doc(currentUserUID)
          .collection("classroom")
          .doc(subjectId)
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("display-subjectCode").innerText = data.code || "ไม่ระบุ";
              document.getElementById("display-subjectName").innerText = data.name || "ไม่ระบุ";
            }
        });
        // ✅ โหลดรายการเช็คชื่อ หลังจากที่ currentUserUID ได้ค่าแล้ว
        loadCheck();
        loadStudent();
      }else {
        console.log("ผู้ใช้ยังไม่ได้ล็อกอิน");
      }
    });

    // เมื่อคลิกปุ่มแสดง QR Code
    document.getElementById("btn-qr").addEventListener("click", function(){
      // แสดง modal สำหรับ QR Code
      document.getElementById("qr-modal").style.display = "block";
      // ล้าง container ก่อนสร้างใหม่ (กรณีคลิกหลายครั้ง)
      document.getElementById("qr-code").innerHTML = "";
      // สร้าง URL สำหรับการลงทะเบียนวิชาโดยใช้ subjectId
      const registrationUrl = `https://yourdomain.com/register?subjectId=${subjectId}`;
      // สร้าง QR Code ด้วย registrationUrl
      new QRCode(document.getElementById("qr-code"), {
        text: registrationUrl,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    });

    // ฟังก์ชันปิด modal QR Code
    function closeQR() {
      document.getElementById("qr-modal").style.display = "none";
    }

    function toggleCreateQiuz(){
      window.location.href = `createQuiz.html?subjectId=${subjectId}`;
    }

    // ฟังก์ชันสำหรับเพิ่มการเช็คชื่อ
    // เมื่อคลิกปุ่มเพิ่มการเช็คชื่อ
    document.getElementById("btn-checkin").addEventListener("click", function(){
      document.getElementById("checkin-modal").style.display = "block";
    });

    // เมื่อคลิกปุ่มปิดใน Modal การเช็คชื่อ
    document.getElementById("close-checkin-modal").addEventListener("click", function(){
      document.getElementById("checkin-modal").style.display = "none";
    });

    // จัดการการส่งฟอร์มใน Modal สำหรับสร้างเช็คชื่อใหม่
    document.getElementById("checkin-form-modal").addEventListener("submit", function(event) {
      event.preventDefault();

      const checkinCode = document.getElementById("modal-checkin-code").value;
      const startTime = new Date(document.getElementById("modal-start-time").value).getTime();
      const lateTime = new Date(document.getElementById("modal-late-time").value).getTime();
      const closeTime = new Date(document.getElementById("modal-close-time").value).getTime();

      // สร้างเอกสารใหม่ที่ path: /classroom/{cid}/checkin/{checkinCode}
      db.collection("users").doc(currentUserUID).collection("classroom").doc(subjectId).collection("checkin").doc(checkinCode).set({
        checkinCode: checkinCode,
        startTime: startTime,
        lateTime: lateTime,
        closeTime: closeTime,
        createdAt: Date.now()
      }).then(() => {
        alert("สร้างการเช็คชื่อสำเร็จ!");
        document.getElementById("checkin-modal").style.display = "none";

        // ขั้นตอนคัดลอกรายชื่อนักเรียนจาก /classroom/{cid}/students
        // ไปยัง /classroom/{cid}/checkin/{checkinCode}/scores โดยกำหนด status = 0
        db.collection("classroom").doc(cid).collection("students").get().then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const studentData = doc.data();
            db.collection("classroom").doc(cid).collection("checkin").doc(checkinCode)
              .collection("scores").doc(doc.id).set({
                status: 0,
                studentName: studentData.name || ""
              });
          });
        }).catch((error) => {
          console.error("เกิดข้อผิดพลาดในการคัดลอกรายชื่อนักเรียน: ", error);
        });
      }).catch((error) => {
        console.error("เกิดข้อผิดพลาดในการสร้างเช็คชื่อ: ", error);
      });
    });
    function loadCheck(userId) {
    const CheckList = document.getElementById("checkin-list");
    CheckList.innerHTML = "<li>กำลังโหลดข้อมูล...</li>";

    if (!currentUserUID || !subjectId) {
        console.error("currentUserUID หรือ subjectId ไม่มีค่า");
        return;
    }

    db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("checkin")
        .orderBy("createdAt", "desc")
        .onSnapshot((querySnapshot) => {
        // ล้างข้อมูลเก่าใน CheckList
        CheckList.innerHTML = "";

        // กรณีไม่มีข้อมูล
        if (querySnapshot.empty) {
            CheckList.innerHTML = "<li>ไม่มีรายการเช็คชื่อ</li>";
            return;
        }

        // สร้าง <ol> สำหรับเก็บรายการเช็คชื่อ
        const ol = document.createElement("ol");

        // วนลูปเอกสารใน collection
        querySnapshot.forEach((doc) => {
            const checkData = doc.data();
            console.log("ข้อมูลที่โหลด: ", checkData);

            // สร้าง <li> สำหรับแต่ละเอกสาร
            const li = document.createElement("li");
            // เนื้อหาหลักที่จะแสดงเสมอ (Title ของแต่ละรายการ)
            li.textContent = `${new Date(checkData.startTime).toLocaleString()} - ${checkData.checkinCode}`;

            // สร้าง element สำหรับข้อมูลเพิ่มเติม (Dropdown)
            const detailDiv = document.createElement("div");
            // ซ่อนข้อมูลเพิ่มเติมไว้ก่อน
            detailDiv.style.display = "none";
            detailDiv.style.marginTop = "5px";
            detailDiv.style.paddingLeft = "20px";
            const table = document.createElement("table");
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            table.innerHTML = `
            <thead>
                <tr>
                <th style="border: 1px solid #ddd; padding: 8px;">ลำดับ</th>
                <th style="border: 1px solid #ddd; padding: 8px;">เลขประจำตัว</th>
                <th style="border: 1px solid #ddd; padding: 8px;">ชื่อ</th>
                <th style="border: 1px solid #ddd; padding: 8px;">สถานะ</th>
                <th style="border: 1px solid #ddd; padding: 8px;">หมายเหตุ</th>
                </tr>
            </thead>
            <tbody id="studentTableBody-${doc.id}">
                <tr>
                <td colspan="2" style="border: 1px solid #ddd; padding: 8px;">กำลังโหลดข้อมูล...</td>
                </tr>
            </tbody>
            `;
            detailDiv.appendChild(table);

            // ดึงข้อมูลนักเรียนจาก collection "Student"
            db.collection("users")
            .doc(currentUserUID)
            .collection("classroom")
            .doc(subjectId).collection("Student")
            .get()
            .then((querySnapshot) => {
                const tbody = document.getElementById(`studentTableBody-${doc.id}`);
                tbody.innerHTML = ""; // ล้างข้อมูลเก่า

                if (querySnapshot.empty) {
                tbody.innerHTML = "<tr><td colspan='2' style='border: 1px solid #ddd; padding: 8px;'>ไม่มีนักเรียนลงทะเบียน</td></tr>";
                return;
                }

                let index = 1;
                querySnapshot.forEach((studentDoc) => {
                const studentData = studentDoc.data();
                console.log("ข้อมูลนักเรียนที่โหลด: ", studentData);
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${index++}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${studentData.sid || "ไม่มีชื่อ"}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${studentData.name || "ไม่มีชื่อ"}</td>
                `;
                tbody.appendChild(tr);
                });
            })
            .catch((error) => {
                console.error("Error fetching student data:", error);
            });

            // เมื่อคลิกที่ <li> ให้สลับการแสดง/ซ่อน dropdown (detailDiv)
            li.addEventListener("click", () => {
            detailDiv.style.display = detailDiv.style.display === "none" ? "block" : "none";
            });

            // นำ detailDiv (Dropdown) ไปแนบกับ <li>
            li.appendChild(detailDiv);
            // ใส่ <li> ลงใน <ol>
            ol.appendChild(li);
        });

        // นำ <ol> ที่สร้างเสร็จแล้วไปใส่ใน CheckList
        CheckList.appendChild(ol);
        });
    }


    // ✅ โหลดรายชื่อนักเรียน
    function loadStudent() {
        const studentTableBody = document.getElementById("student-table-body");
        studentTableBody.innerHTML = "<tr><td colspan='5'>กำลังโหลดข้อมูล...</td></tr>";

        if (!currentUserUID || !subjectId) {
            console.error("currentUserUID หรือ subjectId ไม่มีค่า");
            return;
        }

        db.collection("Student").get()
          .then((querySnapshot) => {
              studentTableBody.innerHTML = ""; // ล้างข้อมูลเก่า
 
              if (querySnapshot.empty) {
                  studentTableBody.innerHTML = "<tr><td colspan='5'>ไม่มีนักเรียนลงทะเบียน</td></tr>";
                  return;
              }

              let index = 1;
              querySnapshot.forEach((doc) => {
                  const studentData = doc.data();
                  console.log("ข้อมูลนักเรียนที่โหลด: ", studentData);

                  // สร้างแถวของนักเรียน
                  const tr = document.createElement("tr");
                  tr.innerHTML = `
                      <td>${index++}</td>
                      <td>${studentData.name || "ไม่มีชื่อ"}</td>
                  `;
                  studentTableBody.appendChild(tr);
              });
          });
    }
    function toCheckin(subjectId) {
        window.location.href = `check-in.html?subjectId=${subjectId}`;
    }

  </script>
</body>
</html>