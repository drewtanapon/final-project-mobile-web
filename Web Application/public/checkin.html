<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
  <!-- QRCode.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      background-image: url('‡∏â‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô.gif'); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
      background-size: cover; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
      background-position: center; /* ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    }
    /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß */
    .header {
      background-image: url('subject-bg.jpg'); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô dynamic ‡πÑ‡∏î‡πâ */
      background-size: cover;
      background-position: center;
      padding: 20px;
      min-height: 250px;
      background-repeat: no-repeat;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      transition: background-image 0.5s ease-in-out;
    }
    .subject-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .subject-code {
      color: #fffefe;
      font-size: 24px;
      font-weight: bold;
    }
    .subject-name {
      color: #ffffff;
      font-size: 20px;
      margin-top: 5px;
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô header */
    .header .buttons {
      margin-top: 15px;
    }
    .header .buttons button {
      margin-right: 10px;
      padding: 8px 12px;
      background-color: #007bff;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      transition: background-color 0.3s;
    }
    .header .buttons button:hover {
      background-color: #0056b3;
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ */
    .header .buttons .checkin-btn {
      background-color: #28a745;
    }
    .header .buttons .checkin-btn:hover {
      background-color: #218838;
    }
    /* ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ó‡πá‡∏ö */
    .tab {
      display: flex;
      background-color: #ccc;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    .tab a {
      flex: 1;
      text-align: center;
      background-color: inherit;
      text-decoration: none;
      padding: 14px 16px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 16px;
      border-right: 1px solid #bbb;
      color: #000;
    }
    .tab a:last-child { border-right: none; }
    .tab a:hover { background-color: #ddd; }
    .tab a.active { background-color: #fff; font-weight: bold; }
    /* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å */
    .container {
      background-color: #493824e3;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      color: #ffffff;
    }
    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
    .history {
      margin-top: 30px;
    }
    .history h3 {
      margin-bottom: 10px;
    }
    .history ul {
      list-style-type: none;
      padding: 0;
    }
    .history li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    /* Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code */
    #qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #qr-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 300px;
      text-align: center;
      border-radius: 8px;
      position: relative;
    }
    #qr-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
    }
    /* Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ */
    #checkin-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(41, 98, 37, 0.895);
    }
    #checkin-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 400px;
      border-radius: 8px;
      position: relative;
    }
    #checkin-modal .modal-content h3 { margin-top: 0; }
    #checkin-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô Modal */
    #checkin-form-modal div { margin-bottom: 10px; }
    #checkin-form-modal label { display: block; margin-bottom: 5px; }
    #checkin-form-modal input {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
    #checkin-form-modal button {
      padding: 8px 12px;
      background-color: #28a745;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #checkin-form-modal button:hover { background-color: #218838; }
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
    #btn-back {
      margin-right: 10px;
      padding: 8px 12px;
      background-color: #007bff;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß -->
  <div class="header" id="header">
    <div class="subject-info">
      <div class="subject-code">
        <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤: </strong><span id="display-subjectCode"></span></p>
      </div>
      <div class="subject-name">
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤: </strong><span id="display-subjectName"></span></p>
      </div>
    </div>
    <div class="buttons">
      <button id="btn-qr">‡πÅ‡∏™‡∏î‡∏á QR Code</button>
      <button id="btn-back" onclick="goBack()">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
      <button id="btn-open-checkin" class="checkin-btn">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
      <button id="btn-close-checkin" class="checkin-btn">‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
    </div>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á QR Code -->
  <div id="qr-modal">
    <div class="modal-content">
      <span class="close" onclick="closeQR()">√ó</span>
      <div id="qr-code">
        <!-- QR Code ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
      </div>
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ó‡πá‡∏ö -->
  <div class="tab">
    <a href="#" onclick="toggleManage()">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
    <a href="#" class="active">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</a>
    <a href="#" onclick="toQuiz()">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</a>
  </div>

  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö -->
  <div class="container">
    <div class="history">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2 style="margin: 0;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h2>
        <button id="btn-checkin"
          style="padding:8px 12px; background-color:#1c6b2c; border:none; color:#fff; border-radius:4px; cursor:pointer;">
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
        </button>
      </div>
      <ul id="checkin-history">
        <li id="checkin-list"></li>
      </ul>
    </div>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
  <div id="checkin-modal">
    <div class="modal-content">
      <span class="close" id="close-checkin-modal">√ó</span>
      <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</h3>
      <form id="checkin-form-modal">
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
          <input type="text" id="modal-checkin-code" required>
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
          <input type="datetime-local" id="modal-start-time" required>
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏¢:</label>
          <input type="datetime-local" id="modal-late-time" required>
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
          <input type="datetime-local" id="modal-close-time" required>
        </div>
        <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </form>
    </div>
  </div>

  <script>
    // ‡∏î‡∏∂‡∏á subjectId ‡∏à‡∏≤‡∏Å query string ‡∏´‡∏£‡∏∑‡∏≠ sessionStorage
    let urlParams = new URLSearchParams(window.location.search);
    let subjectId = urlParams.get('subjectId') || sessionStorage.getItem('subjectId');
    if (!subjectId) {
      console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö subjectId");
    } else {
      console.log("‚úÖ subjectId:", subjectId);
      sessionStorage.setItem('subjectId', subjectId);
    }

    let currentUserUID = "";
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö checkinCode ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let currentCheckinCode = "";

    const firebaseConfig = {
      apiKey: "AIzaSyAPOWp35o6ubJy0SE_PlAqimqa1-siXfVk",
      authDomain: "webmobileapplication-cdaaf.firebaseapp.com",
      projectId: "webmobileapplication-cdaaf",
      storageBucket: "webmobileapplication-cdaaf.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUserUID = user.uid;
        db.collection("users")
          .doc(currentUserUID)
          .collection("classroom")
          .doc(subjectId)
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("display-subjectCode").innerText = data.code || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
              document.getElementById("display-subjectName").innerText = data.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
              if (data.photo) {
                document.getElementById("header").style.backgroundImage = `url('${data.photo}')`;
              }
            }
          });
        loadCheck();
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å check-in ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ manageClass)
        loadStudentScores();
      } else {
        console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
    function toggleManage() {
      window.location.href = `manageClass.html?subjectId=${subjectId}`;
    }
    function toQuiz() {
      window.location.href = `showQuiz.html?subjectId=${subjectId}`;
    }
    function goBack() {
      window.location.href = "index.html";
    }
    function closeQR() {
      document.getElementById("qr-modal").style.display = "none";
    }

    // ‡πÅ‡∏™‡∏î‡∏á QR Code
    document.getElementById("btn-qr").addEventListener("click", function(){
      document.getElementById("qr-modal").style.display = "block";
      document.getElementById("qr-code").innerHTML = "";
      const registrationUrl = `https://yourdomain.com/register?subjectId=${subjectId}`;
      new QRCode(document.getElementById("qr-code"), {
        text: registrationUrl,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡πÅ‡∏™‡∏î‡∏á modal)
    document.getElementById("btn-checkin").addEventListener("click", function(){
      document.getElementById("checkin-modal").style.display = "block";
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    document.getElementById("close-checkin-modal").addEventListener("click", function(){
      document.getElementById("checkin-modal").style.display = "none";
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    document.getElementById("btn-open-checkin").addEventListener("click", function(){
      if (!currentCheckinCode) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠");
        return;
      }
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("checkin")
        .doc(currentCheckinCode)
        .update({ status: "open" })
        .then(() => {
          alert("‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
        })
        .catch((error) => {
          console.error("‚ùå Error opening check-in:", error);
        });
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    document.getElementById("btn-close-checkin").addEventListener("click", function(){
      if (!currentCheckinCode) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠");
        return;
      }
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("checkin")
        .doc(currentCheckinCode)
        .update({ status: "closed" })
        .then(() => {
          // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô subcollection "scores"
          db.collection("users")
            .doc(currentUserUID)
            .collection("classroom")
            .doc(subjectId)
            .collection("checkin")
            .doc(currentCheckinCode)
            .collection("scores")
            .get()
            .then((snapshot) => {
              snapshot.forEach((doc) => {
                const data = doc.data();
                // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏°‡∏≤" ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 1
                if (data.status === "‡∏°‡∏≤") {
                  let newScore = (data.score || 0) + 1;
                  doc.ref.update({ score: newScore });
                }
              });
              alert("‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            })
            .catch((error) => {
              console.error("‚ùå Error updating scores:", error);
            });
        })
        .catch((error) => {
          console.error("‚ùå Error closing check-in:", error);
        });
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô modal)
    document.getElementById("checkin-form-modal").addEventListener("submit", function(event) {
      event.preventDefault();
      const checkinCode = document.getElementById("modal-checkin-code").value;
      const startTime = new Date(document.getElementById("modal-start-time").value).getTime();
      const lateTime = new Date(document.getElementById("modal-late-time").value).getTime();
      const closeTime = new Date(document.getElementById("modal-close-time").value).getTime();

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ checkin ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô path:
      // /users/{currentUserUID}/classroom/{subjectId}/checkin/{checkinCode}
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("checkin")
        .doc(checkinCode)
        .set({
          checkinCode: checkinCode,
          startTime: startTime,
          lateTime: lateTime,
          closeTime: closeTime,
          createdAt: Date.now()
        })
        .then(() => {
          alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          document.getElementById("checkin-modal").style.display = "none";
          currentCheckinCode = checkinCode; // ‡πÄ‡∏Å‡πá‡∏ö checkinCode ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

          // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å collection "Student" ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
          // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á subcollection "scores" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ checkin ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
          db.collection("users")
            .doc(currentUserUID)
            .collection("classroom")
            .doc(subjectId)
            .collection("Student")
            .get()
            .then((studentSnapshot) => {
              studentSnapshot.forEach((studentDoc) => {
                const studentData = studentDoc.data();
                db.collection("users")
                  .doc(currentUserUID)
                  .collection("classroom")
                  .doc(subjectId)
                  .collection("checkin")
                  .doc(checkinCode)
                  .collection("scores")
                  .doc(studentDoc.id)  // ‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô "Student"
                  .set({
                    status: 0, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠)
                    studentName: studentData.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
                    sid: studentData.sid || "-",
                    score: 0   // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 0
                  })
                  .catch((error) => {
                    console.error("‚ùå Error adding student to scores:", error);
                  });
              });
            })
            .catch((error) => {
              console.error("‚ùå Error fetching students:", error);
            });
        })
        .catch((error) => {
          console.error("‚ùå Error creating check-in:", error);
        });
    });

    let unsubscribeCheckin = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î checkin)
    function loadCheck() {
      console.log("Loading check-in data...");
      const CheckList = document.getElementById("checkin-list");
      CheckList.innerHTML = "<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>";
      if (!currentUserUID || !subjectId) {
        console.error("‚ùå currentUserUID ‡∏´‡∏£‡∏∑‡∏≠ subjectId ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤");
        return;
      }
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("checkin")
        .orderBy("createdAt", "desc")
        .onSnapshot((querySnapshot) => {
          CheckList.innerHTML = "";
          if (querySnapshot.empty) {
            CheckList.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</li>";
            return;
          }
          const ol = document.createElement("ol");
          querySnapshot.forEach((checkDoc) => {
            const checkData = checkDoc.data();
            console.log("üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î:", checkData);
            const li = document.createElement("li");
            li.textContent = `${new Date(checkData.startTime).toLocaleString()} - ${checkData.checkinCode}`;
            const detailDiv = document.createElement("div");
            detailDiv.style.display = "none";
            detailDiv.style.marginTop = "5px";
            detailDiv.style.paddingLeft = "20px";
            const table = document.createElement("table");
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            table.innerHTML = `
              <thead>
                <tr>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
              </thead>
              <tbody id="studentTableBody-${checkData.checkinCode}">
                <tr>
                  <td colspan="7" style="border: 1px solid #ddd; padding: 8px;">‡∏Å‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                </tr>
              </tbody>
            `;
            detailDiv.appendChild(table);
            li.addEventListener("click", () => {
              if (detailDiv.style.display === "none") {
                detailDiv.style.display = "block";
                loadCheckinStudents(currentUserUID, subjectId, checkData.checkinCode);
              } else {
                detailDiv.style.display = "none";
              }
            });
            li.appendChild(detailDiv);
            ol.appendChild(li);
          });
          CheckList.appendChild(ol);
        });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å subcollection "Student" ‡πÉ‡∏ô check-in
    // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠)
    function loadCheckinStudents(currentUserUID, subjectId, checkinCode) {
      if (!currentUserUID || !subjectId || !checkinCode) {
        console.error("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: currentUserUID, subjectId ‡∏´‡∏£‡∏∑‡∏≠ checkinCode ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤");
        return;
      }
      const tbody = document.getElementById(`studentTableBody-${checkinCode}`);
      tbody.innerHTML = "<tr><td colspan='7'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";
      // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å collection "Student" (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      db.collection("Student")
        .get()
        .then((studentQuery) => {
          const students = {};
          studentQuery.forEach((doc) => {
            let studentData = doc.data();
            // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
            // (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á DB ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
            students[doc.id] = {
              sid: studentData.sid || "-",
              name: studentData.name || "-",
              status: "-",
              date: "-",
              time: "-",
              remake: "-"
            };
          });
          // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å subcollection "Student" ‡πÉ‡∏ô check-in (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          db.collection("users")
            .doc(currentUserUID)
            .collection("classroom")
            .doc(subjectId)
            .collection("checkin")
            .doc(checkinCode)
            .collection("Student")
            .get()
            .then((checkinQuery) => {
              checkinQuery.forEach((doc) => {
                if (students[doc.id]) {
                  students[doc.id].status = doc.data().status || "-";
                  students[doc.id].date = doc.data().date || "-";
                  students[doc.id].time = doc.data().time || "-";
                  students[doc.id].remake = doc.data().remake || "-";
                }
              });
              tbody.innerHTML = "";
              let index = 1;
              for (const studentId in students) {
                const st = students[studentId];
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td style="border: 1px solid #ddd; padding: 8px;">${index++}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${st.sid}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${st.name}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${st.status}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${st.date}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${st.time}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${st.remake}</td>
                `;
                tbody.appendChild(tr);
              }
            })
            .catch((error) => {
              console.error("‚ùå Error loading checkin status:", error);
            });
        })
        .catch((error) => {
          console.error("‚ùå Error loading students:", error);
        });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å check-in ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ manageClass)
    function loadStudentScores() {
      const studentTableBody = document.getElementById("student-table-body");
      studentTableBody.innerHTML = "<tr><td colspan='5'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";
      if (!currentUserUID || !subjectId) {
        console.error("currentUserUID ‡∏´‡∏£‡∏∑‡∏≠ subjectId ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤");
        return;
      }
      // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å collection "Student" ‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("Student")
        .get()
        .then((studentSnapshot) => {
          const students = {};
          studentSnapshot.forEach((doc) => {
            students[doc.id] = {
              sid: doc.data().sid || "-",
              name: doc.data().name || "-",
              img: doc.data().img || "",
              score: 0
            };
          });
          // 2. ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ check-in ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (order by createdAt desc, limit 1)
          db.collection("users")
            .doc(currentUserUID)
            .collection("classroom")
            .doc(subjectId)
            .collection("checkin")
            .orderBy("createdAt", "desc")
            .limit(1)
            .get()
            .then((checkinSnapshot) => {
              if (!checkinSnapshot.empty) {
                const checkinDoc = checkinSnapshot.docs[0];
                const checkinCode = checkinDoc.id;
                // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å subcollection "scores" ‡πÉ‡∏ô checkinDoc
                db.collection("users")
                  .doc(currentUserUID)
                  .collection("classroom")
                  .doc(subjectId)
                  .collection("checkin")
                  .doc(checkinCode)
                  .collection("scores")
                  .get()
                  .then((scoresSnapshot) => {
                    scoresSnapshot.forEach((scoreDoc) => {
                      if (students[scoreDoc.id]) {
                        students[scoreDoc.id].score = scoreDoc.data().score || 0;
                      }
                    });
                    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô")
                    studentTableBody.innerHTML = "";
                    let index = 1;
                    for (const studentId in students) {
                      const st = students[studentId];
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                        <td style="border: 1px solid #ddd; padding: 8px;">${index++}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${st.sid}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${st.name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;"><img src="${st.img}" alt="${st.name}" width="50"></td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${st.score}</td>
                      `;
                      studentTableBody.appendChild(tr);
                    }
                  })
                  .catch((error) => {
                    console.error("‚ùå Error loading scores:", error);
                  });
              } else {
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ check-in ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î, ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0
                studentTableBody.innerHTML = "";
                let index = 1;
                for (const studentId in students) {
                  const st = students[studentId];
                  const tr = document.createElement("tr");
                  tr.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${index++}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${st.sid}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${st.name}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;"><img src="${st.img}" alt="${st.name}" width="50"></td>
                    <td style="border: 1px solid #ddd; padding: 8px;">0</td>
                  `;
                  studentTableBody.appendChild(tr);
                }
              }
            })
            .catch((error) => {
              console.error("‚ùå Error loading latest checkin:", error);
            });
        })
        .catch((error) => {
          console.error("‚ùå Error loading students:", error);
        });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadStudentScores ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    function loadStudent() {
      loadStudentScores();
    }
  </script>
</body>
</html>
