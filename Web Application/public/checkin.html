<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ */
    .header {
      background-image: url('subject-bg.jpg'); /* ‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô dynamic */
      background-size: cover;
      background-position: center;
      padding: 20px;
      min-height: 250px;
      background-repeat: no-repeat;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      transition: background-image 0.5s ease-in-out;
    }
     /* ========== ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ó‡πá‡∏ö ========== */
     .tab {
      display: flex;
      background-color: #ccc;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    .tab a {
      flex: 1;
      text-align: center;
      background-color: inherit;
      text-decoration: none;
      padding: 14px 16px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 16px;
      border-right: 1px solid #bbb;
      color: #000;
    }
    .tab a:last-child {
      border-right: none;
    }
    .tab a:hover {
      background-color: #ddd;
    }
    .tab a.active {
      background-color: #fff;
      font-weight: bold;
    }
    .tabcontent {
      background-color: #fff;
      padding: 20px;
      border-radius: 0 8px 8px 8px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .subject-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .subject-code {
      color: #fffefe;
      font-size: 24px;
      font-weight: bold;
    }
    .subject-name {
      color: #ffffff;
      font-size: 20px;
      margin-top: 5px;
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß */
    .header .buttons {
      margin-top: 15px;
    }
    .header .buttons button {
      margin-right: 10px;
      padding: 8px 12px;
      background-color: #007bff;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .header .buttons button:hover {
      background-color: #0056b3;
    }
    /* ========== ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ó‡πá‡∏ö ========== */
    .tab {
      display: flex;
      background-color: #ccc;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    .tab a {
      flex: 1;
      text-align: center;
      background-color: inherit;
      text-decoration: none;
      padding: 14px 16px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 16px;
      border-right: 1px solid #bbb;
      color: #000;
    }
    .tab a:last-child {
      border-right: none;
    }
    .tab a:hover {
      background-color: #ddd;
    }
    .tab a.active {
      background-color: #fff;
      font-weight: bold;
    }
    /* ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å */
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 0 8px 8px 8px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô */
    .student-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .student-table th, .student-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .student-table th {
      background-color: #007bff;
      color: #fff;
    }
    /* ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ */
    .history {
      margin-top: 30px;
    }
    .history h3 {
      margin-bottom: 10px;
    }
    .history ul {
      list-style-type: none;
      padding: 0;
    }
    .history li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    /* Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á QR Code */
    #qr-modal {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #qr-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 300px;
      text-align: center;
      border-radius: 8px;
      position: relative;
    }
    #qr-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
    }
    /* Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ */
    #checkin-modal {
      display: none;
      position: fixed;
      top:0;
      left:0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #checkin-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 400px;
      border-radius: 8px;
      position: relative;
    }
    #checkin-modal .modal-content h3 {
      margin-top: 0;
    }
    #checkin-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô Modal */
    #checkin-form-modal div {
      margin-bottom: 10px;
    }
    #checkin-form-modal label {
      display: block;
      margin-bottom: 5px;
    }
    #checkin-form-modal input {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
    #checkin-form-modal button {
      padding: 8px 12px;
      background-color: #28a745;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #checkin-form-modal button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ -->
  <div class="header" id="header">
    <div class="subject-info">
      <div class="subject-code">
        <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤: </strong><span id="display-subjectCode"></span></p>
      </div>
      <div class="subject-name">
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤: </strong><span id="display-subjectName"></span></p>
      </div>
    </div>
    <div class="buttons">
      <button id="btn-qr">‡πÅ‡∏™‡∏î‡∏á QR Code</button>
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ó‡πá‡∏ö 3 ‡∏õ‡∏∏‡πà‡∏° -->
<div class="tab">
  <!-- ‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‚Äù (‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô active -->
  <a href="#" onclick="toggleManage()">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
  <a href="checkin.html?subjectId=${subjectId}" class="active">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</a>
  <a href="#" onclick="toggleQiuz()">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</a>
</div>


  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ -->
  <div class="container">
    <button id="btn-checkin">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
    <div class="history">
      <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
      <ul id="checkin-history">
        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        <li id="checkin-list"></li>
      </ul>
    </div>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ -->
  <div id="checkin-modal">
    <div class="modal-content">
      <span class="close" id="close-checkin-modal">√ó</span>
      <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</h3>
      <form id="checkin-form-modal">
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
          <input type="text" id="modal-checkin-code" required>
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
          <input type="datetime-local" id="modal-start-time" required>
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏¢:</label>
          <input type="datetime-local" id="modal-late-time" required>
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</label>
          <input type="datetime-local" id="modal-close-time" required>
        </div>
        <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </form>
    </div>
  </div>

  <script>
    // ‡∏î‡∏∂‡∏á subjectId ‡∏à‡∏≤‡∏Å query string
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('subjectId');

    console.log(subjectId);

    let currentUserUID = "";
    const firebaseConfig = {
      apiKey: "AIzaSyAPOWp35o6ubJy0SE_PlAqimqa1-siXfVk",
      authDomain: "webmobileapplication-cdaaf.firebaseapp.com",
      projectId: "webmobileapplication-cdaaf",
      storageBucket: "webmobileapplication-cdaaf.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å Firestore ‡∏î‡πâ‡∏ß‡∏¢ subjectId
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUserUID = user.uid;
        db.collection("users")
          .doc(currentUserUID)
          .collection("classroom")
          .doc(subjectId)
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("display-subjectCode").innerText = data.code || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
              document.getElementById("display-subjectName").innerText = data.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
              // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï background-image ‡∏Ç‡∏≠‡∏á header
              if (data.photo) {
                document.getElementById("header").style.backgroundImage = `url('${data.photo}')`;
              }
            }
        });
        loadCheck();
      }else {
        console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      }
    });

    function toggleManage() {
        window.location.href = `manageClass.html?subjectId=${subjectId}`;
    }
    function toggleQuiz() {
        window.location.href = `quiz.html?subjectId=${subjectId}`;
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    document.getElementById("btn-checkin").addEventListener("click", function(){
      document.getElementById("checkin-modal").style.display = "block";
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Modal ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    document.getElementById("close-checkin-modal").addEventListener("click", function(){
      document.getElementById("checkin-modal").style.display = "none";
    });

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
    document.getElementById("checkin-form-modal").addEventListener("submit", function(event) {
      event.preventDefault();

      const checkinCode = document.getElementById("modal-checkin-code").value;
      const startTime = new Date(document.getElementById("modal-start-time").value).getTime();
      const lateTime = new Date(document.getElementById("modal-late-time").value).getTime();
      const closeTime = new Date(document.getElementById("modal-close-time").value).getTime();

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà path: /classroom/{cid}/checkin/{checkinCode}
      db.collection("users").doc(currentUserUID).collection("classroom").doc(subjectId).collection("checkin").doc(checkinCode).set({
        checkinCode: checkinCode,
        startTime: startTime,
        lateTime: lateTime,
        closeTime: closeTime,
        createdAt: Date.now()
      }).then(() => {
        alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        document.getElementById("checkin-modal").style.display = "none";

        // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å /classroom/{cid}/students
        // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á /classroom/{cid}/checkin/{checkinCode}/scores ‡πÇ‡∏î‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î status = 0
        db.collection("classroom").doc(cid).collection("students").get().then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const studentData = doc.data();
            db.collection("classroom").doc(cid).collection("checkin").doc(checkinCode)
              .collection("scores").doc(doc.id).set({
                status: 0,
                studentName: studentData.name || ""
              });
          });
        }).catch((error) => {
          console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ", error);
        });
      }).catch((error) => {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠: ", error);
      });
    });
    let unsubscribeCheckin = null;

    function toggleCheck(){
      window.location.href = `checkin.html?subjectId=${subjectId}`;
    }

    function toggleQiuz(){
      window.location.href = `showQuiz.html?subjectId=${subjectId}`;
    }


    function loadCheck() {
      console.log("Loading check-in data");  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á

      const CheckList = document.getElementById("checkin-list");
      CheckList.innerHTML = "<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>";

      if (!currentUserUID || !subjectId) {
          console.error("‚ùå currentUserUID ‡∏´‡∏£‡∏∑‡∏≠ subjectId ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤");
          return;
      }

      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("checkin")
        .orderBy("createdAt", "desc")
        .onSnapshot((querySnapshot) => {
            CheckList.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            if (querySnapshot.empty) {
                CheckList.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</li>";
                return;
              }

              const ol = document.createElement("ol");
              querySnapshot.forEach((doc) => {
                  const checkData = doc.data();
                  console.log("üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î: ", checkData);

                  const li = document.createElement("li");
                  li.textContent = `${new Date(checkData.startTime).toLocaleString()} - ${checkData.checkinCode}`;

                  const detailDiv = document.createElement("div");
                  detailDiv.style.display = "none";
                  detailDiv.style.marginTop = "5px";
                  detailDiv.style.paddingLeft = "20px";

                  const table = document.createElement("table");
                  table.style.width = "100%";
                  table.style.borderCollapse = "collapse";
                  table.innerHTML = `
                      <thead>
                          <tr>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡∏ä‡∏∑‡πà‡∏≠</th>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡πÄ‡∏ß‡∏•‡∏≤</th>
                              <th style="border: 1px solid #ddd; padding: 8px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                          </tr>
                      </thead>
                      <tbody id="studentTableBody-${checkData.checkinCode}">
                          <tr>
                              <td colspan="7" style="border: 1px solid #ddd; padding: 8px;">‡∏Å‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                          </tr>
                      </tbody>
                  `;
                  detailDiv.appendChild(table);

                  li.addEventListener("click", () => {
                      if (detailDiv.style.display === "none") {
                          detailDiv.style.display = "block";
                          loadCheckinStudents(currentUserUID, subjectId, checkData.checkinCode);
                      } else {
                          detailDiv.style.display = "none";
                      }
                  });

                  li.appendChild(detailDiv);
                  ol.appendChild(li);
              });

              CheckList.appendChild(ol);
          });
    }

    function loadCheckinStudents(currentUserUID, subjectId, checkinCode) {
      if (!currentUserUID || !subjectId || !checkinCode) {
          console.error("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: currentUserUID, subjectId ‡∏´‡∏£‡∏∑‡∏≠ checkinCode ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤");
          return;
      }

      const tbody = document.getElementById(`studentTableBody-${checkinCode}`);
      tbody.innerHTML = "<tr><td colspan='7'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";

      // 1Ô∏è‚É£ ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .collection("Student")
        .get()
        .then((studentQuery) => {
            const students = {};
            studentQuery.forEach((doc) => {
                students[doc.id] = {
                    sid: doc.data().sid || "-",
                    name: doc.data().name || "-",
                    status: "-",
                    date: "-",
                    time: "-",
                    remake: "-"
                };
            });

            // 2Ô∏è‚É£ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Check-in ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            db.collection("users")
              .doc(currentUserUID)
              .collection("classroom")
              .doc(subjectId)
              .collection("checkin")
              .doc(checkinCode)
              .collection("Student")
              .get()
              .then((checkinQuery) => {
                  checkinQuery.forEach((doc) => {
                      if (students[doc.id]) {
                          students[doc.id].status = doc.data().status || "-";
                          students[doc.id].date = doc.data().date || "-";
                          students[doc.id].time = doc.data().time || "-";
                          students[doc.id].remake = doc.data().remake || "-";
                      }
                  });

                  // 3Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Check-in ‡∏ô‡∏±‡πâ‡∏ô
                  tbody.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
                  let index = 1;
                  for (const studentId in students) {
                      const student = students[studentId];
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                          <td style="border: 1px solid #ddd; padding: 8px;">${index++}</td>
                          <td style="border: 1px solid #ddd; padding: 8px;">${student.sid}</td>
                          <td style="border: 1px solid #ddd; padding: 8px;">${student.name}</td>
                          <td style="border: 1px solid #ddd; padding: 8px;">${student.status}</td>
                          <td style="border: 1px solid #ddd; padding: 8px;">${student.date}</td>
                          <td style="border: 1px solid #ddd; padding: 8px;">${student.time}</td>
                          <td style="border: 1px solid #ddd; padding: 8px;">${student.remake}</td>
                      `;
                      tbody.appendChild(tr);
                  }
              })
              .catch((error) => {
                  console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠: ", error);
              });
        })
        .catch((error) => {
            console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ", error);
        });
    } 

    function loadSubjectInfo() {
      db.collection("users")
        .doc(currentUserUID)
        .collection("classroom")
        .doc(subjectId)
        .get()
        .then((doc) => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById("display-subjectCode").innerText = data.code || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            document.getElementById("display-subjectName").innerText = data.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
          }
        });
    }
  </script>
</body>
</html>
