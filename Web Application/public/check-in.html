<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Check-in Page</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
  <!-- QRCode.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* กำหนดสไตล์พื้นฐาน */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    .header {
      background-image: url('subject-bg.jpg'); /* เปลี่ยนเป็น dynamic หากมีข้อมูล */
      background-size: cover;
      background-position: center;
      padding: 20px;
      color: #fff;
    }
    .header h1, .header h2 {
      margin: 0;
      padding: 5px;
    }
    .button-group {
      margin: 10px 20px;
    }
    .button-group button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      background-color: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .button-group button:hover {
      background-color: #0056b3;
    }
    .container {
      margin: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    table th {
      background-color: #007bff;
      color: #fff;
    }
    /* QR Code Modal */
    #qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #qr-modal .modal-content {
      background: #fff;
      margin: 100px auto;
      padding: 20px;
      width: 300px;
      text-align: center;
      border-radius: 8px;
      position: relative;
    }
    #qr-modal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Header: แสดงข้อมูลวิชา -->
  <div class="header">
    <h1 id="subject-code">รหัสวิชา: </h1>
    <h2 id="subject-name">ชื่อวิชา: </h2>
  </div>

  <!-- ปุ่มการจัดการ -->
  <div class="button-group">
    <button id="btn-exit">ออก</button>
    <button id="btn-open">เปิดเช็คชื่อ</button>
    <button id="btn-close">ปิดเช็คชื่อ</button>
    <button id="btn-save-checkin">บันทึกการเช็คชื่อ</button>
    <button id="btn-show-checkin-code">แสดงรหัสเช็คชื่อ</button>
    <button id="btn-show-qr">แสดง QRCode วิชา</button>
    <button id="btn-qa">ถาม-ตอบ</button>
    <button id="btn-show-list">แสดงรายชื่อ</button>
    <button id="btn-show-scores">แสดงคะแนน</button>
  </div>

  <!-- ส่วนแสดงรายชื่อผู้เช็คชื่อ (Realtime) -->
  <div class="container" id="checkin-list-container">
    <h3>รายชื่อผู้ที่เช็คชื่อ</h3>
    <div id="checkin-list">
      <!-- ตารางรายชื่อจะถูกแสดงที่นี่ -->
    </div>
  </div>

  <!-- ส่วนแสดงคะแนน (แก้ไขได้) -->
  <div class="container" id="scores-container" style="display: none;">
    <h3>คะแนนเช็คชื่อ</h3>
    <div id="scores-list">
      <!-- ตารางคะแนนจะถูกแสดงที่นี่ -->
    </div>
    <button id="btn-save-scores">บันทึกข้อมูล</button>
  </div>

  <!-- Modal สำหรับแสดง QR Code -->
  <div id="qr-modal">
    <div class="modal-content">
      <span class="close" onclick="closeQR()">×</span>
      <div id="qr-code"></div>
    </div>
  </div>

  <script>
    // Firebase configuration & initialization
    const firebaseConfig = {
      apiKey: "AIzaSyAPOWp35o6ubJy0SE_PlAqimqa1-siXfVk",
      authDomain: "webmobileapplication-cdaaf.firebaseapp.com",
      projectId: "webmobileapplication-cdaaf",
      storageBucket: "webmobileapplication-cdaaf.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Global variables
    let currentUserUID = "";
    // ดึง subjectId, cno จาก URL (หรือกำหนดค่าดีฟอลต์)
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('subjectId') || "defaultSubjectId";
    const cno = urlParams.get('cno') || "defaultCno"; // รหัสการเช็คชื่อ (checkin session)
    const cid = subjectId; // สมมุติว่า subjectId ใช้เป็น cid

    // โหลดข้อมูลวิชา (รหัส, ชื่อ, รูปภาพพื้นหลัง)
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUserUID = user.uid;
        db.collection("users").doc(currentUserUID)
          .collection("classroom").doc(subjectId)
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("subject-code").innerText = "รหัสวิชา: " + (data.code || "ไม่ระบุ");
              document.getElementById("subject-name").innerText = "ชื่อวิชา: " + (data.name || "ไม่ระบุ");
              // ปรับ background หากมี field backgroundImage
              if(data.b
