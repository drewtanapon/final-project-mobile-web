<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
  <style>
    body { text-align: center; padding: 20px; background-color: #f0f8ff; }
    .container { width: 400px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px #888888; }
    input, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; }
    button { background-color: #0000cc; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #000099; }
    .hidden { display: none; }
    img { border-radius: 50%; }
    .from { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Avatar Options */
    #avatar-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    #avatar-options img {
      width: 80px;
      height: 80px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 50%;
    }
    #avatar-options img.selected {
      border-color: blue;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
    <img id="profile-pic" src="imageprofiledefault.jpg" alt="Profile Picture" width="100">
    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="display-username"></span></p>
    <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="display-email"></span></p>
    <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="display-phone"></span></p>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div id="edit-form" class="hidden">
      <!-- ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ input file ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î -->
      <input type="file" id="profile-image">
      <div id="avatar-options">
        <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç path ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ forward slashes -->
        <img src="asset/avatar1.png" class="avatar-option" data-url="asset/avatar1.png" alt="Avatar 1">
        <img src="asset/avatar2.png" class="avatar-option" data-url="asset/avatar2.png" alt="Avatar 2">
        <img src="asset/avatar3.png" class="avatar-option" data-url="asset/avatar3.png" alt="Avatar 3">
        <img src="asset/avatar4.png" class="avatar-option" data-url="asset/avatar4.png" alt="Avatar 4">
        <img src="asset/avatar5.png" class="avatar-option" data-url="asset/avatar5.png" alt="Avatar 5">
        <img src="asset/avatar6.png" class="avatar-option" data-url="asset/avatar6.png" alt="Avatar 6">
      </div>
      <input type="text" id="username" class="from" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
      <input type="email" id="email" class="from" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
      <input type="tel" id="phone" class="from" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
      
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Avatar ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ -->
      
    </div>

    <button id="edit-btn" onclick="toggleEdit(true)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button id="save-btn" class="hidden" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="cancel-btn" class="hidden" onclick="toggleEdit(false)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button onclick="window.location.href='index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <script>
    // üî• ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAPOWp35o6ubJy0SE_PlAqimqa1-siXfVk",
      authDomain: "webmobileapplication-cdaaf.firebaseapp.com",
      projectId: "webmobileapplication-cdaaf",
      storageBucket: "webmobileapplication-cdaaf.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUserUID = ""; // UID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
    let selectedAvatarUrl = ""; // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏Ç‡∏≠‡∏á Avatar ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUserUID = user.uid; // ‡πÉ‡∏ä‡πâ UID ‡πÄ‡∏õ‡πá‡∏ô Document ID

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        db.collection("users").doc(currentUserUID).onSnapshot(doc => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById("display-username").innerText = data.displayName || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            document.getElementById("display-email").innerText = data.email || user.email;
            document.getElementById("display-phone").innerText = data.phone;
            const profilePic = document.getElementById("profile-pic");
            profilePic.src = data.photoURL ? data.photoURL : "imageprofiledefault.jpg";
          }
        });
      } else {
        window.location.href = "login.html"; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    function toggleEdit(editMode) {
      document.getElementById("edit-form").classList.toggle("hidden", !editMode);
      document.getElementById("edit-btn").classList.toggle("hidden", editMode);
      document.getElementById("save-btn").classList.toggle("hidden", !editMode);
      document.getElementById("cancel-btn").classList.toggle("hidden", !editMode);
      if (editMode) {
        document.getElementById("username").value = document.getElementById("display-username").innerText;
        document.getElementById("email").value = document.getElementById("display-email").innerText;
        document.getElementById("phone").value = document.getElementById("display-phone").innerText;
      }
    }

    // ‡∏à‡∏±‡∏ö event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Avatar Options
    const avatarOptions = document.querySelectorAll(".avatar-option");
    avatarOptions.forEach(option => {
      option.addEventListener("click", function(){
        // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏Ç‡∏≠‡∏á Avatar ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        selectedAvatarUrl = this.getAttribute("data-url");
        // highlight ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° class "selected"
        avatarOptions.forEach(o => o.classList.remove("selected"));
        this.classList.add("selected");
      });
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile
    async function saveProfile() {
      if (!currentUserUID) return;
      const username = document.getElementById("username").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const file = document.getElementById("profile-image").files[0];

      let updateData = { 
        username, 
        email, 
        phone 
      };

      try {
        // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Firebase Storage ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        if (file) {
          const storageRef = storage.ref(`profile_pictures/${currentUserUID}`);
          const snapshot = await storageRef.put(file);
          const url = await snapshot.getDownloadURL();
          updateData.photoURL = url;
        }
        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Avatar ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Avatar ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        else if (selectedAvatarUrl) {
          updateData.photoURL = selectedAvatarUrl;
        }

        await db.collection("users").doc(currentUserUID).set(updateData, { merge: true });
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        location.reload();
      } catch (error) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }
  </script>
</body>
</html>
