<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

  <style>
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô GIF ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    body {
      margin: 0;
      padding: 20px;
      text-align: center;
      background: url("‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå.gif") no-repeat center center fixed;
      background-size: cover; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
      font-family: Arial, sans-serif;
    }

    .container {
      width: 400px;
      margin: auto;
      background: rgba(97, 140, 45, 0.882);
      color: rgb(255, 255, 255);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px #ffffff;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      box-sizing: border-box;
    }

    button {
      background-color: #6c471a;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #4e3311;
    }

    .hidden {
      display: none;
    }

    img {
      border-radius: 50%;
    }

    .from {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Avatar Options */
    #avatar-options {
      display: flex;
      flex-direction: column; /* ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÅ‡∏ñ‡∏ß */
      gap: 10px;
      margin-top: 10px;
    }

    .avatar-row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .avatar-option {
      width: 80px;
      height: 80px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 50%;
    }

    .avatar-option.selected {
      border-color: blue;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
    <!-- HTML -->
  <img id="profile-pic" src="imageprofiledefault.jpg" alt="Profile Picture">
  <!-- CSS -->
  <style>
  #profile-pic {
    width: 100px;       /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    height: 100px;      /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    border-radius: 50%; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏° */
    object-fit: cover;  /* ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏î‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô */
  }
</style>

    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="display-username"></span></p>
    <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="display-email"></span></p>
    <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="display-phone"></span></p>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div id="edit-form" class="hidden">
      <!-- Input file ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏≠‡∏á -->
      <input type="file" id="profile-image">

      <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Avatar ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ -->
      <div id="avatar-options">
        <!-- üîπ ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: Avatar1,2,3 + oldAvatar (‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) -->
        <div class="avatar-row"> 
          <!-- oldAvatar (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ oldPhotoURL) -->
          <img id="oldAvatar" class="avatar-option" data-url="" alt="Old Avatar" style="display: none;">
          <img src="asset/avatar1.png" class="avatar-option" data-url="asset/avatar1.png" alt="Avatar 1">
          <img src="asset/avatar2.png" class="avatar-option" data-url="asset/avatar2.png" alt="Avatar 2">
          <img src="asset/avatar3.png" class="avatar-option" data-url="asset/avatar3.png" alt="Avatar 3">

        </div>

        <!-- üîπ ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: Avatar4,5,6 -->
        <div class="avatar-row">
          <img src="asset/avatar4.png" class="avatar-option" data-url="asset/avatar4.png" alt="Avatar 4">
          <img src="asset/avatar5.png" class="avatar-option" data-url="asset/avatar5.png" alt="Avatar 5">
          <img src="asset/avatar6.png" class="avatar-option" data-url="asset/avatar6.png" alt="Avatar 6">
        </div>
      </div>

      <input type="text" id="username" class="from" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
      <input type="email" id="email" class="from" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
      <input type="tel" id="phone" class="from" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
    </div>

    <button id="edit-btn" onclick="toggleEdit(true)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button id="save-btn" class="hidden" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="cancel-btn" class="hidden" onclick="toggleEdit(false)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button onclick="window.location.href='index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <script>
    // (1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Config (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á)
    const firebaseConfig = {
      apiKey: "AIzaSyAPOWp35o6ubJy0SE_PlAqimqa1-siXfVk",
      authDomain: "webmobileapplication-cdaaf.firebaseapp.com",
      projectId: "webmobileapplication-cdaaf",
      storageBucket: "webmobileapplication-cdaaf.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUserUID = "";
    let selectedAvatarUrl = "";

    // (2) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Persistence ‡πÅ‡∏ö‡∏ö Promise then/catch
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => {
        console.log("Persistence set to LOCAL");
      })
      .catch(err => {
        console.error("Error setting persistence:", err);
      });

    // (3) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        currentUserUID = user.uid;
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        db.collection("users").doc(currentUserUID).onSnapshot(doc => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById("display-username").innerText = data.displayName || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            document.getElementById("display-email").innerText = data.email || user.email;
            document.getElementById("display-phone").innerText = data.phone || "-";

            const profilePic = document.getElementById("profile-pic");
            profilePic.src = data.photoURL ? data.photoURL : "imageprofiledefault.jpg";

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ oldPhotoURL ‚Üí ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô oldAvatar
            if (data.oldPhotoURL) {
              const oldAvatarEl = document.getElementById("oldAvatar");
              oldAvatarEl.src = data.oldPhotoURL;
              oldAvatarEl.dataset.url = data.oldPhotoURL;
              oldAvatarEl.style.display = "inline-block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ
            }
          } else {
            console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firestore");
          }
        });
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
        window.location.href = "login.html";
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    function toggleEdit(editMode) {
      document.getElementById("edit-form").classList.toggle("hidden", !editMode);
      document.getElementById("edit-btn").classList.toggle("hidden", editMode);
      document.getElementById("save-btn").classList.toggle("hidden", !editMode);
      document.getElementById("cancel-btn").classList.toggle("hidden", !editMode);

      if (editMode) {
        document.getElementById("username").value = document.getElementById("display-username").innerText;
        document.getElementById("email").value = document.getElementById("display-email").innerText;
        document.getElementById("phone").value = document.getElementById("display-phone").innerText;
      }
    }

    // ‡∏à‡∏±‡∏ö event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Avatar Options
    const avatarOptions = document.querySelectorAll(".avatar-option");
    avatarOptions.forEach(option => {
      option.addEventListener("click", function(){
        selectedAvatarUrl = this.getAttribute("data-url");
        avatarOptions.forEach(o => o.classList.remove("selected"));
        this.classList.add("selected");
      });
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile
    async function saveProfile() {
      if (!currentUserUID) return;

      const username = document.getElementById("username").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const file = document.getElementById("profile-image").files[0];

      let updateData = {
        displayName: username,
        email: email,
        phone: phone
      };

      try {
        // 1) ‡∏î‡∏∂‡∏á doc ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ photoURL ‡πÄ‡∏î‡∏¥‡∏°
        const userDoc = await db.collection("users").doc(currentUserUID).get();
        let oldPhoto = userDoc.exists && userDoc.data().photoURL ? userDoc.data().photoURL : "";

        // 2) ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‚Üí ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
        if (file) {
          const storageRef = storage.ref(`profile_pictures/${currentUserUID}`);
          const snapshot = await storageRef.put(file);
          const url = await snapshot.ref.getDownloadURL();
          updateData.photoURL = url;
          if (oldPhoto) {
            updateData.oldPhotoURL = oldPhoto;
          }
        }
        // 3) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Avatar ‡πÉ‡∏´‡∏°‡πà
        else if (selectedAvatarUrl) {
          updateData.photoURL = selectedAvatarUrl;
          if (oldPhoto) {
            updateData.oldPhotoURL = oldPhoto;
          }
        }

        // 4) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firestore
        await db.collection("users").doc(currentUserUID).set(updateData, { merge: true });
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        location.reload();
      } catch (error) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }
  </script>
</body>
</html>
