import React, { useEffect, useState } from "react";
import { View, Text, FlatList, TouchableOpacity, Alert, ActivityIndicator, StyleSheet, Image, TextInput } from "react-native";
import { auth, db, collection, doc, getDocs, getDoc, setDoc } from "./firebaseConfig";
import { get } from "react-native/Libraries/TurboModule/TurboModuleRegistry";

const ShowClassScreen = ({ navigation }) => {
  const [classes, setClasses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [studentId, setStudentId] = useState("");
  const [isCheckinOpen, setIsCheckinOpen] = useState(false);

  const fetchClasses = async () => {
    try {
        const user = auth.currentUser;
        if (!user) {
            Alert.alert("тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╣Гр╕лр╕бр╣И");
            navigation.replace("Login");
            return;
        }
        
        setStudentId(user.uid);
        const studentRef = doc(db, "Student", user.uid);
        const subjectListRef = collection(studentRef, "subjectList");
        const querySnapshot = await getDocs(subjectListRef);

        if (querySnapshot.empty) {
            setClasses([]);
            return;
        }

        // 1я╕ПтГг р╕Фр╕╢р╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕г classId р╕Вр╕нр╕Зр╕зр╕┤р╕Кр╕▓р╕Чр╕╡р╣Ир╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕Вр╣Йр╕▓р╕гр╣Ир╕зр╕б
        const classIds = querySnapshot.docs.map(doc => doc.id);

        // 2я╕ПтГг р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕зр╕┤р╕Кр╕▓р╕Ир╕▓р╕Б classroom р╕Хр╕▓р╕б classIds
        const classPromises = classIds.map(async (classId) => {
            const classRef = doc(db, "classroom", classId);
            const classSnap = await getDoc(classRef);
            
            if (classSnap.exists()) {
                return { id: classId, ...classSnap.data().info }; // тЬЕ р╕Фр╕╢р╕З info р╕Чр╕╡р╣Ир╕бр╕╡ code р╣Бр╕ер╕░ room
            }
            return null;
        });

        // 3я╕ПтГг р╕гр╕зр╕Ър╕гр╕зр╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕зр╕┤р╕Кр╕▓
        const classData = (await Promise.all(classPromises)).filter(Boolean);
        setClasses(classData);

    } catch (error) {
        Alert.alert("тЭМ р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф", error.message);
    }
    setLoading(false);
};


  useEffect(() => {
    fetchClasses();
    checkCheckinStatus();
    const unsubscribe = navigation.addListener("focus", () => {
      fetchClasses();
      checkCheckinStatus();
    });
    return unsubscribe;
  }, [navigation]);

  // р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н
  const markAttendance = async (classId, remark) => {
    try {
        const user = auth.currentUser;
        if (!user) {
            Alert.alert("тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ");
            return;
        }

        // тЬЕ р╕Вр╕нр╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н (Check-in Code)
        Alert.prompt(
            "р╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н",
            "р╣Вр╕Ыр╕гр╕Фр╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╕Чр╕╡р╣Ир╕нр╕▓р╕Ир╕▓р╕гр╕вр╣Мр╣Гр╕лр╣Йр╕бр╕▓р╕Бр╣Ир╕нр╕Щр╕Бр╕Фр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н",
            [
                {
                    text: "р╕вр╕Бр╣Ар╕ер╕┤р╕Б",
                    style: "cancel",
                },
                {
                    text: "р╕Хр╕Бр╕ер╕З",
                    onPress: async (inputCode) => {
                        if (!inputCode) {
                            Alert.alert("тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н");
                            return;
                        }

                        console.log("ЁЯУМ Check-in Code р╕Чр╕╡р╣Ир╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╕Бр╕гр╕нр╕Б:", inputCode);

                        // тЬЕ р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╕Ир╕▓р╕Б Firestore
                        const studentRef = doc(db, "Student", user.uid);
                        const studentSnap = await getDoc(studentRef);

                        if (!studentSnap.exists()) {
                            Alert.alert("тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ");
                            return;
                        }

                        const studentData = studentSnap.data();
                        const sid = studentData.studentId || "N/A";
                        const username = studentData.username || "р╣Др╕бр╣Ир╕бр╕╡р╕Кр╕╖р╣Ир╕н";

                        // тЬЕ р╣Вр╕лр╕ер╕Ф checkin р╕Чр╕╡р╣Ир╣Ар╕Ыр╕┤р╕Фр╕нр╕вр╕╣р╣И р╣Бр╕ер╕░р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕гр╕лр╕▒р╕к
                        const checkInRef = collection(db, "classroom", classId, "checkin");
                        const checkinCollec = await getDocs(checkInRef);

                        if (checkinCollec.empty) {
                            Alert.alert("тЭМ р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н");
                            return;
                        }

                        let checkinMatched = false;

                        for (const docSnap of checkinCollec.docs) {
                            const docData = docSnap.data();

                            if (docData.status === 1 && docData.checkinCode === inputCode) {
                                checkinMatched = true;

                                const now = new Date();
                                const dateStr = now.toISOString().split("T")[0];
                                const timeStr = now.toLocaleTimeString("en-GB", { hour12: false });
                                const timestamp = now.getTime();

                                console.log("ЁЯУМ р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╣Др╕Ы Firestore:", dateStr, timeStr, timestamp);

                                // тЬЕ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ер╕З Firestore
                                const studentDocRef = doc(
                                    db,
                                    "classroom", classId,
                                    "checkin", docSnap.id,
                                    "students", user.uid
                                );

                                await setDoc(studentDocRef, {
                                    studentId: sid,
                                    username: username,
                                    date: dateStr,
                                    time: timeStr,
                                    timestamp: timestamp,
                                    remark: remark || "р╣Др╕бр╣Ир╕бр╕╡р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕",
                                }, { merge: true });

                                console.log("тЬЕ р╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕Ир╕кр╕│р╕лр╕гр╕▒р╕Ъ", user.uid);
                                Alert.alert("тЬФя╕П р╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И!");
                                break; // р╕лр╕вр╕╕р╕Ф loop р╕Чр╕▒р╕Щр╕Чр╕╡р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И
                            }
                        }

                        if (!checkinMatched) {
                            Alert.alert("тЭМ р╕гр╕лр╕▒р╕кр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╕лр╕гр╕╖р╕нр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╕Ыр╕┤р╕Фр╣Бр╕ер╣Йр╕з");
                        }
                    },
                },
            ],
            "plain-text"
        );
    } catch (error) {
      console.error("тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф:", error);
      Alert.alert("тЭМ р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф", error.message);
    }
};

const checkCheckinStatus = async () => {
  try {
    const classId = "your_class_id_here"; // тЪая╕П р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Ар╕Ыр╣Зр╕Щ classId р╕Ир╕гр╕┤р╕З р╣Ж
    const checkInRef = collection(db, "classroom", classId, "checkin");
    const checkinCollec = await getDocs(checkInRef);

    let checkinOpen = false;

    checkinCollec.forEach((docSnap) => {
      const docData = docSnap.data();
      if (docData.status === 1) {
        checkinOpen = true;
      }
    });

    setIsCheckinOpen(checkinOpen);
  } catch (error) {
    console.error("тЭМ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф:", error);
  }
};


  const handleAttendance = (classId) => {
    Alert.prompt(
      "р╕Бр╕гр╕нр╕Бр╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕",
      "р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Бр╕▓р╕гр╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕н р╕бр╕▓р╕Хр╕гр╕Зр╣Ар╕зр╕ер╕▓ р╕лр╕гр╕╖р╕нр╕бр╕▓р╕кр╕▓р╕в р╣Ар╕Юр╕гр╕▓р╕░р╕нр╕░р╣Др╕г?",
      [
        {
          text: "р╕вр╕Бр╣Ар╕ер╕┤р╕Б",
          style: "cancel",
        },
        {
          text: "р╕Хр╕Бр╕ер╕З",
          onPress: (remark) => markAttendance(classId, remark || "р╣Др╕бр╣Ир╕бр╕╡р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕"),
        },
      ],
      "plain-text"
    );
  };

  return (
    <View style={styles.container}>
      <Text style={styles.title}>ЁЯУЪ р╕гр╕▓р╕вр╕зр╕┤р╕Кр╕▓р╕Чр╕╡р╣Ир╣Ар╕гр╕╡р╕вр╕Щ</Text>
      {loading ? (
        <ActivityIndicator size="large" color="#007bff" />
      ) : classes.length > 0 ? (
<FlatList
    data={classes}
    keyExtractor={(item) => item.id}
    renderItem={({ item }) => (
        <View style={styles.classItem}>
            <Text style={styles.classText}>ЁЯУЦ {item.name} ({item.code})</Text>
            <Text style={styles.roomText}>ЁЯУН р╕лр╣Йр╕нр╕З: {item.room || "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕"}</Text>
            <TouchableOpacity
                style={styles.attendanceButton}
                onPress={() => handleAttendance(item.id)}
            >
                <Text style={styles.buttonText}>тЬФя╕П р╣Ар╕Кр╣Зр╕Др╕Кр╕╖р╣Ир╕нр╣Ар╕Вр╣Йр╕▓р╣Ар╕гр╕╡р╕вр╕Щ</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.attendanceButton}x  
                onPress={() => {
                  if (item.id) {
                    
                    navigation.navigate("ClassDetail", { cid: item.id });
                  } else {
                    Alert.alert("тЪая╕П р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З");
                  }
                }}
              >
                <Text style={styles.buttonText}>тЬФя╕П р╣Ар╕Вр╣Йр╕▓р╕лр╣Йр╕нр╕Зр╣Ар╕гр╕╡р╕вр╕Щ</Text>
              </TouchableOpacity>
            </View>
          )}
        />
      ) : (
        <Text style={styles.noClassText}>тЭМ р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕гр╕▓р╕вр╕зр╕┤р╕Кр╕▓р╕Чр╕╡р╣Ир╣Ар╕гр╕╡р╕вр╕Щ</Text>
      )}
      <TouchableOpacity style={styles.backButton} onPress={() => navigation.goBack()}>
        <Text style={styles.buttonText}>ЁЯФЩ р╕вр╣Йр╕нр╕Щр╕Бр╕ер╕▒р╕Ъ</Text>
      </TouchableOpacity>
    </View>
  );
};

const styles = StyleSheet.create({
  background: {
    flex: 1,
    width,
    height,
  },
  container: {
    flex: 0.95,
    justifyContent: "flex-start",
    alignItems: "center",
    paddingHorizontal: 20,
    paddingTop: 80,
    backgroundColor: "rgba(0,0,0,0.3)", // р╣Вр╕Ыр╕гр╣Ир╕Зр╣Гр╕кр╣Ар╕ер╣Зр╕Бр╕Щр╣Йр╕нр╕вр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Ар╕Фр╣Ир╕Щр╕Вр╕╢р╣Йр╕Щ
  },
  title: {
    fontSize: 28,
    fontWeight: "bold",
    color: "#fff", // р╣Гр╕лр╣Йр╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕гр╕кр╕╡р╕Вр╕▓р╕зр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕нр╣Ир╕▓р╕Щр╕Зр╣Ир╕▓р╕в
    marginBottom: 20,
  },
  classItem: {
    backgroundColor: "#F8F8FF",
    padding: 180,
    marginVertical: 15,
    borderRadius: 10,
    width: "100%",
    alignItems: "center",
    alignSelf: "center",
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 5 },
    shadowOpacity: 0.3,
    shadowRadius: 5,
    elevation: 5,
  },
  classImage: {
    width: 80,
    height: 80,
    marginBottom: 10,
    borderRadius: 8,
  },
  classText: {
    color: "#000000",
    fontSize: 18,
  },
  roomText: {
    color: "#000000",
    fontSize: 16,
    marginBottom: 10,
  },
  attendanceButton: {
    backgroundColor: "#28a745",
    marginTop: 10,
    paddingVertical: 10,
    paddingHorizontal: 20,
    borderRadius: 8,
  },
  buttonText: {
    color: "#fff",
    fontSize: 18,
  },
  backButton: {
    backgroundColor: "#d9534f",
    width: "80%",
    paddingVertical: 15,
    alignItems: "center",
    borderRadius: 12,
    position: "absolute",
    bottom: 20,
    alignSelf: "center",
  },
  noClassText: {
    fontSize: 18,
    color: "#fff",
    marginTop: 20,
  },
});

export default ShowClassScreen;
